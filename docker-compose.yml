services:
  preflight:
    image: debian:${DEBIAN_VERSION}
    container_name: ${APP_NAME}-preflight
    command:
      - /bin/bash
      - '-c'
      - |
        find /preflight \( -name '*.sh' -o -name '*.env' -o -name 'crontab.*' \) -exec sed -i -e 's/\r//g' {} \;
        chmod +x /preflight/bin/run-script.sh
    volumes:
      - ./bin/:/preflight/bin
      - ./config:/preflight/config
      - ./cron:/preflight/cron
      - ./scripts:/preflight/scripts
  cron:
    image: debian:${DEBIAN_VERSION}
    container_name: ${APP_NAME}-cron
    restart: unless-stopped
    command:
      - /bin/bash
      - '-c'
      - |
        export DEBIAN_FRONTEND=noninteractive
        export CRON_USER=epg
        export CRON_DIR=/cron
        export TARGET_DIR=$${CRON_DIR}
        export ENV_FILE_PATTERN=/scripts/*.env
        export APT_CORE_PACKAGES="sudo ca-certificates curl gnupg"
        export APT_PACKAGES="cron git"
        export X_USER=$$CRON_USER
        # run initialization
        run-script.sh timezone apt adduser apt-install genenv nodejs cron cleanlock setowner +viewlog
        # start cron
        echo "Starting cron..."
        cron -f -L 15
    environment:
      APP_TIMEZONE: ${APP_TIMEZONE}
      APP_GUIDES_DIR: ${APP_GUIDES_DIR}
      APT_MIRROR: ${APT_MIRROR}
      NODE_VERSION: ${NODE_VERSION}
    volumes:
      - ./bin/run-script.sh:/usr/local/bin/run-script.sh
      - ./build:/build
      - ./config:/config
      - ./cron:/cron
      - ./scripts:/scripts
    depends_on:
      preflight:
        condition: service_completed_successfully
  nginx:
    image: nginx
    container_name: ${APP_NAME}-web
    restart: unless-stopped
    command:
      - /bin/bash
      - '-c'
      - |
        # run initialization
        run-script.sh timezone
        # run entrypoint
        /docker-entrypoint.sh nginx -g "daemon off;"
    ports:
      - ${APP_HTTP_PORT}:80
    environment:
      APP_TIMEZONE: ${APP_TIMEZONE}
      APP_GUIDES_DIR: ${APP_GUIDES_DIR}
    volumes:
      - ./bin/run-script.sh:/usr/local/bin/run-script.sh
      - ./build:/build
      - ./scripts:/scripts
      - ./templates:/etc/nginx/templates
    depends_on:
      - cron
